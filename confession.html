<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GDU Confession</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #ff6b81; --muted: rgba(255,255,255,0.12); }
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg,#2b1055,#7597de);
      color: #fff; margin:0; min-height:100vh;
      -webkit-font-smoothing:antialiased;
    }
    header { text-align:center; padding:22px 16px; background: rgba(255,255,255,0.04); box-shadow: 0 4px 10px rgba(0,0,0,0.25); }
    header h1 { margin:0; font-size:1.6rem; letter-spacing:1px; }
    main { max-width:900px; margin:28px auto; padding:0 16px; }
    .card { background: rgba(255,255,255,0.06); padding:18px; border-radius:14px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); margin-bottom:18px; }
    input[type="text"], textarea {
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.03); color:#fff; outline:none; resize:vertical;
      font-size:0.98rem;
    }
    input[type="text"]:focus, textarea:focus { border-color: var(--accent); box-shadow:0 0 8px rgba(255,107,129,0.14); }
    textarea { min-height:72px; }
    .row { display:flex; gap:10px; align-items:center; }
    .left { flex:1; }
    .btn {
      background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    .btn[disabled] { opacity:0.7; cursor:default; }
    .upload-label {
      display:inline-block; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,0.06); cursor:pointer; border:1px dashed rgba(255,255,255,0.06);
    }
    #imagePreview { display:none; margin-top:12px; max-width:100%; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
    .loader {
      display:inline-block; width:34px; height:34px; border-radius:50%; border:4px solid rgba(255,255,255,0.12); border-top:4px solid var(--accent);
      animation:spin .9s linear infinite; vertical-align:middle; margin-left:10px;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* confession list */
    .confession-list .confession {
      margin-top:12px; padding:14px; border-radius:12px; background: rgba(255,255,255,0.03);
    }
    .confession .meta { color:#dfe6ff77; font-size:0.88rem; margin-bottom:6px; }
    .confession img { max-width:100%; border-radius:8px; margin-top:8px; display:block; }

    .hint { color:#e6e6e6aa; font-size:0.9rem; margin-top:6px; }
    footer { text-align:center; color:#eee; opacity:0.8; padding:14px 0; margin-top:20px; }
    @media (max-width:600px){ .row { flex-direction:column; } .btn { width:100%; } .upload-label{width:100%; text-align:center;} }
  </style>
</head>
<body>
  <header>
    <h1>‚ú® GIA ƒê·ªäNH UNIVERSITY CONFESSION ‚ú®</h1>
  </header>

  <main>
    <div class="card">
      <h3>Vi·∫øt Confession m·ªõi</h3>

      <!-- T√™n (decor) -->
      <div style="margin:10px 0;">
        <input id="senderName" type="text" placeholder="Nh·∫≠p t√™n (ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ ·∫©n danh)" />
      </div>

      <!-- Confession text -->
      <div style="margin-bottom:10px;">
        <textarea id="newConfession" placeholder="Nh·∫≠p confession c·ªßa b·∫°n..."></textarea>
      </div>

      <!-- Upload + preview + send -->
      <div class="row" style="align-items:flex-start;">
        <div class="left">
          <label class="upload-label">
            üì∑ Ch·ªçn ·∫£nh
            <input id="confessionImage" type="file" accept="image/*" style="display:none;" />
          </label>
          <div id="imageInfo" class="hint" style="margin-top:8px;">(·∫¢nh kh√¥ng b·∫Øt bu·ªôc ‚Äî t·ªëi ƒëa ~10MB)</div>
          <img id="imagePreview" alt="preview">
        </div>

        <div style="min-width:150px; display:flex; flex-direction:column; gap:8px;">
          <button id="addConfessionBtn" class="btn">G·ª≠i</button>
          <div id="statusWrap" style="display:flex; align-items:center; gap:8px; justify-content:center;">
            <div id="loader" class="loader" style="display:none;"></div>
            <div id="statusText" style="font-size:0.95rem; color:#fff; opacity:0.9;"></div>
          </div>
        </div>
      </div>

      <div class="hint" style="margin-top:12px;">L∆∞u √Ω: ·∫¢nh ƒë∆∞·ª£c upload l√™n ImgBB (mi·ªÖn ph√≠), n·ªôi dung ƒë∆∞·ª£c l∆∞u tr√™n Firebase Firestore.</div>
    </div>

    <!-- Danh s√°ch confession -->
    <div class="card confession-list" id="confessionContainer">
      <h3>Confession m·ªõi nh·∫•t</h3>
      <div id="listInner"></div>
    </div>
  </main>

  <footer>Vi·∫øt b·ªüi B·∫£o Long - GDU Confession</footer>

  <!-- Firebase SDK (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    // --------- C·∫§U H√åNH (Thay 2 ch·ªó n√†y) ----------
    const IMGBB_API_KEY = "46ccb22e2eddd283211566a5482eef7b"; // <-- thay b·∫±ng API key t·ª´ imgbb.com
    const firebaseConfig = {
      apiKey: "AIzaSyACpNff8xGZ-FNmngsDA7mRk8m7G_gFXlo",
      authDomain: "newweb-97f09.firebaseapp.com",
      projectId: "newweb-97f09",
      storageBucket: "newweb-97f09.appspot.com"
      // n·∫øu c√≥ th√™m fields (messagingSenderId, appId) th√¨ t·ªët, nh∆∞ng kh√¥ng b·∫Øt bu·ªôc
    };
    // ---------------------------------------------

    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM
    const fileInput = document.getElementById("confessionImage");
    const preview = document.getElementById("imagePreview");
    const imageInfo = document.getElementById("imageInfo");
    const btn = document.getElementById("addConfessionBtn");
    const loader = document.getElementById("loader");
    const statusText = document.getElementById("statusText");
    const listInner = document.getElementById("listInner");

    let imageFile = null;

    // Preview khi ch·ªçn ·∫£nh
    fileInput.addEventListener("change", (e) => {
      const f = e.target.files[0];
      if (!f) {
        imageFile = null;
        preview.style.display = "none";
        imageInfo.textContent = "(·∫¢nh kh√¥ng b·∫Øt bu·ªôc ‚Äî t·ªëi ƒëa ~10MB)";
        return;
      }
      if (f.size > 10 * 1024 * 1024) { // 10MB limit
        alert("·∫¢nh qu√° l·ªõn (>10MB). Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n.");
        fileInput.value = "";
        return;
      }
      imageFile = f;
      preview.src = URL.createObjectURL(f);
      preview.style.display = "block";
      imageInfo.textContent = `ƒê√£ ch·ªçn: ${f.name} (${Math.round(f.size/1024)} KB)`;
    });

    // H√†m helper: convert file -> base64 (string without prefix)
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file ·∫£nh"));
        reader.onload = () => {
          const result = reader.result; // data:*/*;base64,xxxxx
          // remove prefix "data:image/xxx;base64,"
          const idx = result.indexOf("base64,");
          if (idx === -1) return resolve(result);
          resolve(result.substring(idx + 7));
        };
        reader.readAsDataURL(file);
      });
    }

    // Upload ·∫£nh l√™n ImgBB, tr·∫£ v·ªÅ URL ho·∫∑c throw l·ªói
    async function uploadToImgBB(file) {
      if (!file) return "";
      // chuy·ªÉn sang base64
      const base64 = await fileToBase64(file);
      const form = new FormData();
      form.append("image", base64);
      // optional: form.append("name", "myfile");
      const url = `https://api.imgbb.com/1/upload?key=${encodeURIComponent(IMGBB_API_KEY)}`;
      const res = await fetch(url, { method: "POST", body: form });
      const json = await res.json();
      if (!res.ok || json.status !== 200) {
        // l·∫•y message chi ti·∫øt n·∫øu c√≥
        const errMsg = (json && json.error && json.error.message) ? json.error.message : JSON.stringify(json);
        throw new Error("ImgBB upload failed: " + errMsg);
      }
      return json.data.url;
    }

    // G·ª≠i confession: upload ·∫£nh (n·∫øu c√≥) -> l∆∞u Firestore
    btn.addEventListener("click", async () => {
      const text = document.getElementById("newConfession").value.trim();
      const author = document.getElementById("senderName").value.trim() || "·∫®n danh";
      if (!text && !imageFile) {
        alert("Vui l√≤ng nh·∫≠p confession ho·∫∑c ch·ªçn ·∫£nh!");
        return;
      }

      // UI tr·∫°ng th√°i
      btn.disabled = true;
      loader.style.display = "inline-block";
      statusText.textContent = "ƒêang x·ª≠ l√Ω...";

      try {
        let imageUrl = "";
        if (imageFile) {
          statusText.textContent = "ƒêang t·∫£i ·∫£nh l√™n ImgBB...";
          // th·ª≠ upload
          imageUrl = await uploadToImgBB(imageFile);
          statusText.textContent = "·∫¢nh ƒë√£ upload";
        }

        statusText.textContent = "ƒêang l∆∞u confession...";
        await db.collection("confessions").add({
          text,
          author,
          imageUrl: imageUrl || "",
          likes: 0,
          comments: [],
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // reset form
        document.getElementById("newConfession").value = "";
        document.getElementById("senderName").value = "";
        preview.style.display = "none";
        fileInput.value = "";
        imageFile = null;

        statusText.textContent = "G·ª≠i th√†nh c√¥ng üéâ";
        setTimeout(() => statusText.textContent = "", 2000);
      } catch (err) {
        console.error(err);
        alert("L·ªói khi g·ª≠i: " + (err.message || err));
        statusText.textContent = "L·ªói. Ki·ªÉm tra console.";
      } finally {
        loader.style.display = "none";
        btn.disabled = false;
      }
    });

    // Hi·ªÉn th·ªã danh s√°ch realtime
    db.collection("confessions").orderBy("createdAt","desc").onSnapshot(snapshot => {
      listInner.innerHTML = "";
      snapshot.forEach(doc => {
        const d = doc.data();
        const wrapper = document.createElement("div");
        wrapper.className = "confession";
        const timeText = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate().toLocaleString() : "";
        wrapper.innerHTML = `
          <div class="meta">üë§ <strong>${escapeHtml(d.author || "·∫®n danh")}</strong> ‚Ä¢ <span style="opacity:0.8">${timeText}</span></div>
          <div class="text">${escapeHtml(d.text || "")}</div>
          ${d.imageUrl ? `<img src="${escapeAttr(d.imageUrl)}" alt="image">` : ""}
        `;
        listInner.appendChild(wrapper);
      });
    }, err => {
      console.error("Realtime read error:", err);
      listInner.innerHTML = "<div style='color:#ffd6d6'>Kh√¥ng th·ªÉ ƒë·ªçc d·ªØ li·ªáu. Ki·ªÉm tra console.</div>";
    });

    // small helpers to escape HTML (basic)
    function escapeHtml(str) {
      if (!str) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    function escapeAttr(s) { return escapeHtml(s); }
  </script>
</body>
</html>


