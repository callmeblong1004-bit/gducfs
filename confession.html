<script>
  // Firebase setup
  const firebaseConfig = {
    apiKey: "AIzaSyCMSuIcBzVMYA6XyQooRvrolO1hcmdXRH0",
    authDomain: "webcfs-1bfb4.firebaseapp.com",
    projectId: "webcfs-1bfb4",
    storageBucket: "webcfs-1bfb4.appspot.com",
    messagingSenderId: "341537956821",
    appId: "1:341537956821:web:48e40bf17178ed61c5935c"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // User check
  const currentUser = JSON.parse(localStorage.getItem('currentUser'));
  if(!currentUser) window.location.href='login.html';

  // Header buttons
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    localStorage.removeItem('currentUser');
    window.location.href='login.html';
  });
  document.getElementById('homeBtn').addEventListener('click', ()=>{ window.location.href='index.html'; });

  // Upload ảnh
  const imageUploadBox = document.getElementById('imageUploadBox');
  const postImages = document.getElementById('postImages');
  const imagePreview = document.getElementById('imagePreview');
  const chooseFilesBtn = document.getElementById('chooseFilesBtn');

  chooseFilesBtn.addEventListener('click', ()=> postImages.click());
  imageUploadBox.addEventListener('click', ()=> postImages.click());

  imageUploadBox.addEventListener('dragover', e=>{ e.preventDefault(); imageUploadBox.style.background='rgba(255,255,255,0.2)'; });
  imageUploadBox.addEventListener('dragleave', e=>{ e.preventDefault(); imageUploadBox.style.background='rgba(255,255,255,0.1)'; });
  imageUploadBox.addEventListener('drop', e=>{
    e.preventDefault();
    postImages.files = e.dataTransfer.files;
    showPreview();
    imageUploadBox.style.background='rgba(255,255,255,0.1)';
  });

  postImages.addEventListener('change', showPreview);

  function showPreview(){
    imagePreview.innerHTML = '';
    for(let i=0;i<postImages.files.length;i++){
      const file = postImages.files[i];
      if(file && file.type.startsWith('image/')){
        const reader = new FileReader();
        reader.onload = e=>{
          const img = document.createElement('img');
          img.src = e.target.result;
          imagePreview.appendChild(img);
        }
        reader.readAsDataURL(file);
      }
    }
  }

  // ImgBB key
  const imgbbAPIKey = "46ccb22e2eddd283211566a5482eef7b";

  async function uploadImageToImgbb(file){
    try{
      const formData = new FormData();
      formData.append('image', file);
      const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbAPIKey}`, { method:'POST', body:formData });
      const data = await res.json();
      return data.data.url;
    }catch(err){ console.error(err); return null; }
  }

  const postBtn = document.getElementById('postBtn');
  const postsContainer = document.getElementById('postsContainer');

  async function postNew(){
    const content = document.getElementById('postContent').value.trim();
    const files = Array.from(postImages.files);
    if(!content && files.length === 0){ alert('Nhập nội dung hoặc ảnh!'); return; }

    postBtn.disabled = true;
    postBtn.textContent = "Đang đăng...";

    // Upload tất cả ảnh song song
    const imageUrls = (await Promise.all(files.map(f=>uploadImageToImgbb(f)))).filter(u=>u!=null);

    await db.collection('posts').add({
      user: currentUser.name,
      content,
      images: imageUrls,
      timestamp: new Date(),
      comments: []
    });

    document.getElementById('postContent').value='';
    postImages.value='';
    imagePreview.innerHTML='';
    postBtn.disabled = false;
    postBtn.textContent = "Đăng";

    loadPosts();
  }

  postBtn.addEventListener('click', postNew);

  function renderComments(commentsDiv, comments){
    commentsDiv.innerHTML='';
    comments.forEach(c=>{
      const cDiv = document.createElement('div');
      cDiv.className='comment';
      const avatar = c.user.charAt(0).toUpperCase();
      cDiv.innerHTML=`
        <div class="comment-header">
          <div class="comment-avatar">${avatar}</div>
          ${c.user}
        </div>
        <div class="comment-text">${c.text}</div>
      `;
      commentsDiv.appendChild(cDiv);
    });
  }

  async function loadPosts(){
    postsContainer.innerHTML='';
    const snapshot = await db.collection('posts').orderBy('timestamp','desc').get();
    snapshot.forEach(doc=>{
      const p = doc.data();
      const div = document.createElement('div');
      div.className='post';
      div.innerHTML=`
        <div class="post-header">${p.user}</div>
        <div class="post-content">${p.content || ''}</div>
        ${p.images ? p.images.map(url=>`<img src="${url}">`).join('') : ''}
        <div class="comments"></div>
        <textarea class="comment-input" placeholder="Viết bình luận..."></textarea>
        <button class="btn comment-btn">Bình luận</button>
      `;
      postsContainer.appendChild(div);

      const commentsDiv = div.querySelector('.comments');
      renderComments(commentsDiv, p.comments || []);

      const commentInput = div.querySelector('.comment-input');
      const commentBtn = div.querySelector('.comment-btn');
      commentBtn.addEventListener('click', async ()=>{
        const text = commentInput.value.trim();
        if(!text) return;
        await db.collection('posts').doc(doc.id).update({
          comments: firebase.firestore.FieldValue.arrayUnion({ user: currentUser.name, text })
        });
        commentInput.value='';
        loadPosts();
      });
    });
  }

  loadPosts();
</script>
